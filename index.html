<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS System (LocalStorage)</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/2563eb/ffffff?text=P&font=sans-serif">
    <style>
        /* === Theming variables (light/dark) === */
        :root {
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        /* --- Global Styles --- */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 1rem; /* p-4 mobile */
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @media (min-width: 640px) { /* sm: */
            body {
                padding: 1.5rem; /* p-6 desktop */
            }
        }

        .container { max-width: 1280px; margin: 0 auto; }

        /* --- Header --- */
        .topbar {
            display:flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .brand {
            display:flex;
            gap: 0.75rem;
            align-items:center;
        }
        .brand h1 {
            font-size: 1.25rem; /* text-xl */
            margin: 0;
            font-weight: 700;
        }
        .controls {
            display:flex;
            gap: 0.5rem;
            align-items:center;
            width: 100%; /* Full width on mobile */
        }
        @media (min-width: 640px) { /* sm: */
            .controls {
                width: auto; /* Auto width on desktop */
            }
        }
        .search-input {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            flex-grow: 1; /* Take remaining space */
        }
        /* REMOVED: Theme toggle button style */

        /* --- Tabs --- */
        .tab-nav {
            display:flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            white-space: nowrap;
        }
        .tab-nav button {
            padding: 0.6rem 0.9rem;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid transparent;
            background: transparent;
            color: var(--muted);
            cursor:pointer;
            font-weight: 600;
            flex-shrink: 0;
        }
        .tab-nav button.active {
            color: var(--primary);
            background: var(--card);
            border-color: var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Layout --- */
        .register-layout {
            display:grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media(min-width: 1024px) { /* lg: */
            .register-layout { grid-template-columns: 2fr 1fr; }
        }

        /* --- Card --- */
        .card {
            background: var(--card);
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        @media(min-width: 640px) {
            .card { padding: 1.5rem; }
        }

        .sticky-cart { position: sticky; top: 1.5rem; }

        h2 { margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 600; }
        h3 { margin:0 0 0.75rem 0; font-size: 1rem; color: var(--muted); font-weight: 500; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;}

        input[type="text"], input[type="number"], select {
            width:100%;
            padding:0.5rem 0.75rem;
            border-radius:0.5rem;
            border:1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            box-sizing: border-box;
            font-size: 1rem;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            outline: 2px solid transparent;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .form-grid {
            display:grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        @media(min-width: 768px) {
            .form-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        /* Advanced Filter Controls */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .filter-controls > div {
            flex-grow: 1;
            min-width: 150px; /* Allow wrapping */
        }
        .filter-controls label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: var(--muted);
        }


        button {
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            -webkit-appearance: none;
        }

        .btn {
            display:inline-block;
            padding: 0.6rem 1rem;
            background: var(--primary);
            color: #ffffff;
        }
        .btn:hover { opacity: 0.85; }
        
        .btn-green {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            background: var(--success);
            color: #ffffff;
        }
        .btn-green:disabled { background: var(--muted); opacity: 0.7; }
        
        .btn-gray {
            padding: 0.6rem 1rem;
            background: var(--border);
            color: var(--text);
        }
        
        .btn-red {
            padding: 0.6rem 1rem;
            background: var(--danger);
            color: #ffffff;
        }

        .btn-red-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            background: var(--danger);
            color: #ffffff;
        }

        /* --- Sales Grid / Products --- */
        .sales-grid {
            display:grid;
            gap:0.75rem;
            grid-template-columns: repeat(2, 1fr);
        }
        @media(min-width: 640px) { .sales-grid { grid-template-columns: repeat(3, 1fr); } }
        @media(min-width: 768px) { .sales-grid { grid-template-columns: repeat(4, 1fr); } }
        @media(min-width: 1280px) { .sales-grid { grid-template-columns: repeat(6, 1fr); } }

        .product-card {
            padding:0.75rem;
            border-radius:0.5rem;
            border:1px solid var(--border);
            cursor:pointer;
            transition: all 0.2s;
            background: var(--card);
        }
        .product-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--primary); }
        .product-card .name { font-weight:600; }
        .product-card .price { color: var(--primary); font-weight:600; font-size: 0.875rem; }
        .product-card .category {
            font-size: 0.75rem;
            color: var(--muted);
            background: var(--bg);
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            display: inline-block;
            margin-top: 0.25rem;
        }


        /* List view */
        .sales-grid-list-view { grid-template-columns: 1fr; }
        .sales-grid-list-view .product-card { 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Cart --- */
        .cart-items { max-height: 20rem; overflow-y:auto; margin-bottom:1rem; }
        .cart-item { 
            display:flex; 
            gap:0.75rem; 
            align-items:center; 
            justify-content:space-between; 
            padding:0.75rem 0.25rem; 
            border-bottom:1px solid var(--border); 
        }
        .cart-item .name { font-weight: 600; flex-grow: 1; }
        .cart-item .price { font-size: 0.875rem; color: var(--muted); }
        .qty-controls { display:flex; gap:0.5rem; align-items:center; }
        .qty-btn { 
            width:28px; height:28px; 
            border-radius:999px; 
            border:1px solid var(--border); 
            background:var(--bg); 
            color: var(--text);
            cursor:pointer; 
            font-size: 1rem;
            line-height: 1;
        }
        .qty-btn:hover { background: var(--border); }

        .totals { margin: 1rem 0; display: grid; gap: 0.5rem; }
        .totals div { display:flex; justify-content:space-between; font-weight: 500; }
        .totals .total-row { font-weight:800; font-size:1.25rem; border-top: 2px solid var(--border); padding-top: 0.5rem;}

        /* --- Table / Inventory --- */
        .table-wrapper { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width: 500px; /* Wider for category */ }
        th, td { padding:0.75rem; text-align:left; border-bottom: 1px solid var(--border); }
        th { color: var(--muted); font-weight:600; font-size:0.875rem; }
        td:last-child { text-align: right; }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h2 {
            margin-top: 0;
            color: var(--text);
        }
        .modal-content p {
            color: var(--muted);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }
        .modal-content .btn {
            margin-top: 1rem;
            width: 100%;
            background-color: var(--primary);
            color: #fff;
        }
        /* New styles for confirm modal */
        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            flex-direction: column;
        }
        @media(min-width: 640px) {
            .modal-buttons {
                flex-direction: row;
            }
        }
        .modal-buttons .btn {
            width: 100%;
            margin-top: 0;
        }

        /* --- REMOVED: All @media print styles --- */
        
    </style>
</head>
<body>
    
    <!-- REMOVED: Hidden receipt container -->
    
    <!-- ======== MAIN POS INTERFACE ======== -->
    <div class="container" id="app" data-theme="light">
        <!-- Topbar -->
        <div class="topbar">
            <div class="brand">
                <img src="https" alt="" style="width:32px;height:32px;border-radius:0.375rem;background:var(--primary)"
                    onerror="this.style.display='none'">
                <h1>POS System</h1>
            </div>
            <div class="controls">
                <input id="product-search" class="search-input" placeholder="Search products... (Press /)">
                <!-- REMOVED: Theme toggle button -->
            </div>
        </div>

        <nav class="tab-nav">
            <button id="tab-register" class="active">Sales Register</button>
            <button id="tab-inventory">Inventory</button>
            <button id="tab-settings">Settings</button>
        </nav>

        <!-- --- Tab Content: Register --- -->
        <div id="content-register" class="tab-content active">
            <div class="register-layout">
                <div class="card">
                    <h2>Sales Register</h2>
                    
                    <div class="filter-controls">
                        <div>
                            <label for="filter-category">Filter by Category</label>
                            <select id="filter-category">
                                <option value="all">All Categories</option>
                                <!-- Categories populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="sort-by">Sort by</label>
                            <select id="sort-by">
                                <option value="default">Default</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="price-asc">Price (Low-High)</option>
                                <option value="price-desc">Price (High-Low)</option>
                            </select>
                        </div>
                    </div>

                    <div class="sales-grid" id="sales-grid">
                        <!-- Products will be loaded here by JS -->
                    </div>
                </div>
                
                <div class="card sticky-cart">
                    <h2>Current Sale</h2>
                    <div class="cart-items" id="cart-items">
                        <p style="color: var(--muted); padding: 1rem 0;">Cart is empty.</p>
                    </div>
                    
                    <div class="totals">
                        <div>
                            <span>Subtotal:</span>
                            <span id="cart-subtotal">PKR 0.00</span>
                        </div>
                        <div>
                            <span>Tax (<span id="cart-tax-rate-label">5</span>%):</span>
                            <span id="cart-tax">PKR 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Total:</span>
                            <span id="cart-total">PKR 0.00</span>
                        </div>
                    </div>
                    
                    <button id="pay-button" class="btn-green" disabled>Pay & Print Receipt</button>
                    <button id="clear-cart-button" class="btn-gray" style="width: 100%; margin-top: 0.5rem;">Clear Cart</button>
                </div>
            </div>
        </div>

        <!-- --- Tab Content: Inventory --- -->
        <div id="content-inventory" class="tab-content">
            <div class="card">
                <h2>Inventory Management</h2>
                <form id="add-product-form" class="form-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 1.5rem;">
                    <input type="text" id="product-name" placeholder="Product Name" required style="grid-column: 1 / -1;">
                    <input type="number" id="product-price" placeholder="Price" min="0" step="0.01" required>
                    <input type="text" id="product-sku" placeholder="SKU / Barcode (Optional)">
                    <input type="text" id="product-category" placeholder="Category (e.g. 'Drinks')">
                    
                    <button type="submit" class="btn" style="grid-column: 1 / -1;">Save Product</button>
                </form>
    
                <h3>Product List</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-tbody">
                            <!-- Inventory will be loaded here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- --- Tab Content: Settings --- -->
        <div id="content-settings" class="tab-content">
            <div class="card">
                <h2>Settings</h2>
                
                <form id="settings-form">
                    <h3>Receipt Settings</h3>
                    <div class="form-grid">
                        <input type="text" id="setting-shop-name" placeholder="Shop Name">
                        <input type="text" id="setting-shop-address" placeholder="Shop Address">
                        <input type="text" id="setting-shop-phone" placeholder="Shop Phone">
                    </div>
                    <input type="text" id="setting-footer-note" placeholder="Receipt Footer Note" style="width: 100%; margin-bottom: 1.5rem;">

                    <h3>POS Settings</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="setting-tax-rate" style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--muted);">Tax Rate (%)</label>
                            <input type="number" id="setting-tax-rate" min="0" step="0.1" value="5">
                        </div>
                        <div>
                            <label for="setting-layout" style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--muted);">Sales Layout</label>
                            <select id="setting-layout">
                                <option value="grid">Grid View</option>
                                <option value="list">List View</option>
                            </select>
                        </div>
                        <!-- REMOVED: Theme selector div -->
                    </div>
                    
                    <button type="submit" class="btn">Save Settings</button>
                </form>

                <hr style="margin: 1.5rem 0; border-color: var(--border);">

                <h3>Data Management</h3>
                <div class="form-grid" style="border: none; padding: 0; margin-bottom: 0;">
                    <button id="export-json-btn" class="btn-gray">Export Backup (JSON)</button>
                    <button id="export-csv-btn" class="btn-gray">Export Report (CSV)</button>
                    <div>
                        <label for="import-file" style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--muted);">Import Backup (JSON)</label>
                        <input type="file" id="import-file" accept=".json" style="padding: 0.25rem 0;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REMOVED: Mobile Print Modal -->

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-modal-title">Are you sure?</h2>
            <p id="confirm-modal-message">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="confirm-modal-cancel" class="btn btn-gray">Cancel</button>
                <button id="confirm-modal-confirm" class="btn btn-red">Confirm</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- STATE ---
        let products = [];
        let cart = [];
        let settings = {};
        let confirmCallback = null; 
        
        const DEFAULT_SETTINGS = {
            shopName: "My Web POS",
            shopAddress: "123 Coding Street, Tech City",
            shopPhone: "",
            footerNote: "Thank you for your business!",
            taxRate: 5.0,
            layout: "grid"
        };

        // --- DOM SELECTORS ---
        const appRoot = document.getElementById('app');
        const tabRegister = document.getElementById('tab-register');
        const tabInventory = document.getElementById('tab-inventory');
        const tabSettings = document.getElementById('tab-settings');
        const contentRegister = document.getElementById('content-register');
        const contentInventory = document.getElementById('content-inventory');
        const contentSettings = document.getElementById('content-settings');
        
        // Inventory Page
        const productForm = document.getElementById('add-product-form');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const productSkuInput = document.getElementById('product-sku');
        const productCategoryInput = document.getElementById('product-category');
        const inventoryTbody = document.getElementById('inventory-tbody');
        
        // Register Page
        const salesGrid = document.getElementById('sales-grid');
        const productSearch = document.getElementById('product-search');
        const filterCategory = document.getElementById('filter-category');
        const sortBy = document.getElementById('sort-by');
        
        // Cart
        const cartItemsContainer = document.getElementById('cart-items');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTaxEl = document.getElementById('cart-tax');
        const cartTotalEl = document.getElementById('cart-total');
        const cartTaxRateLabel = document.getElementById('cart-tax-rate-label');
        const payButton = document.getElementById('pay-button');
        const clearCartButton = document.getElementById('clear-cart-button');
        
        // REMOVED: receiptContainer
        // REMOVED: mobilePrintModal, closePrintModalBtn

        // Confirm Modal
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');

        // Settings Page
        const settingsForm = document.getElementById('settings-form');
        const settingShopName = document.getElementById('setting-shop-name');
        const settingShopAddress = document.getElementById('setting-shop-address');
        const settingShopPhone = document.getElementById('setting-shop-phone');
        const settingFooterNote = document.getElementById('setting-footer-note');
        const settingTaxRate = document.getElementById('setting-tax-rate');
        const settingLayout = document.getElementById('setting-layout');
        
        const exportJsonBtn = document.getElementById('export-json-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importFileEl = document.getElementById('import-file');


        // --- LOCALSTORAGE FUNCTIONS ---
        
        function getProducts() {
            try {
                const prods = localStorage.getItem('products');
                return prods ? JSON.parse(prods) : [];
            } catch (e) {
                console.error("Error parsing products from localStorage", e);
                return [];
            }
        }

        function saveProducts(productsToSave) {
            try {
                localStorage.setItem('products', JSON.stringify(productsToSave));
            } catch (e) {
                console.error("Error saving products to localStorage", e);
            }
        }

        function loadSettings() {
            let savedSettings = {};
            try {
                savedSettings = JSON.parse(localStorage.getItem('posSettings')) || {};
            } catch (e) {
                console.error("Error parsing settings", e);
                savedSettings = {};
            }
            settings = { ...DEFAULT_SETTINGS, ...savedSettings };
            saveSettings(); 
        }

        function saveSettings() {
            try {
                localStorage.setItem('posSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("Error saving settings", e);
            }
        }
        
        // --- RENDER FUNCTIONS ---
        
        function renderInventoryList() {
            inventoryTbody.innerHTML = '';
            if (products.length === 0) {
                inventoryTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted);">No products in inventory.</td></tr>';
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(product.name)}</td>
                    <td>PKR ${product.price.toFixed(2)}</td>
                    <td>${escapeHtml(product.sku)}</td>
                    <td>${escapeHtml(product.category)}</td>
                    <td>
                        <button class="btn-red-small delete-btn" data-sku="${product.sku}">Delete</button>
                    </td>
                `;
                inventoryTbody.appendChild(row);
            });
        }
        
        function populateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
            filterCategory.innerHTML = '<option value="all">All Categories</option>'; 
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = escapeHtml(category);
                filterCategory.appendChild(option);
            });
        }

        function renderSalesGrid() {
            salesGrid.innerHTML = '';
            
            const searchTerm = productSearch.value.toLowerCase();
            const categoryFilter = filterCategory.value;
            const sortMethod = sortBy.value;
            
            let visibleProducts = [...products];

            if (searchTerm) {
                visibleProducts = visibleProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.sku.toLowerCase().includes(searchTerm)
                );
            }
            
            if (categoryFilter !== 'all') {
                visibleProducts = visibleProducts.filter(p => p.category === categoryFilter);
            }

            switch (sortMethod) {
                case 'name-asc':
                    visibleProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    visibleProducts.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'price-asc':
                    visibleProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    visibleProducts.sort((a, b) => b.price - a.price);
                    break;
            }

            if (visibleProducts.length === 0) {
                salesGrid.innerHTML = '<p style="color: var(--muted); grid-column: 1 / -1;">No products found.</p>';
                return;
            }
            
            salesGrid.className = 'sales-grid'; 
            if (settings.layout === 'list') {
                salesGrid.classList.add('sales-grid-list-view');
            }

            visibleProducts.forEach(product => {
                const card = document.createElement('button');
                card.className = 'product-card';
                card.dataset.sku = product.sku;
                card.innerHTML = `
                    <div>
                        <span class="name">${escapeHtml(product.name)}</span>
                        <span class="price">PKR ${product.price.toFixed(2)}</span>
                    </div>
                    ${product.category ? `<span class="category">${escapeHtml(product.category)}</span>` : ''}
                `;
                salesGrid.appendChild(card);
            });
        }
        
        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p style="color: var(--muted); padding: 1rem 0;">Cart is empty.</p>';
                payButton.disabled = true;
                updateTotals(0, 0, 0);
                return;
            }
            
            let subtotal = 0;
            cart.forEach(item => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="name">${escapeHtml(item.name)}</div>
                    <div class="qty-controls">
                        <button class="qty-btn" data-sku="${item.sku}" data-action="decrement">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" data-sku="${item.sku}" data-action="increment">+</button>
                    </div>
                    <div class="price">PKR ${itemTotal.toFixed(2)}</div>
                `;
                cartItemsContainer.appendChild(cartItem);
            });
            
            const tax = subtotal * (settings.taxRate / 100);
            const total = subtotal + tax;
            updateTotals(subtotal, tax, total);
            payButton.disabled = false;
        }
        
        function updateTotals(subtotal, tax, total) {
            cartSubtotalEl.textContent = `PKR ${subtotal.toFixed(2)}`;
            cartTaxEl.textContent = `PKR ${tax.toFixed(2)}`;
            cartTotalEl.textContent = `PKR ${total.toFixed(2)}`;
            cartTaxRateLabel.textContent = settings.taxRate;
        }

        function updateSettingsUI() {
            settingShopName.value = settings.shopName;
            settingShopAddress.value = settings.shopAddress;
            settingShopPhone.value = settings.shopPhone;
            settingFooterNote.value = settings.footerNote;
            settingTaxRate.value = settings.taxRate;
            settingLayout.value = settings.layout;
        }
        
        function refreshAllUI() {
            products = getProducts();
            populateCategoryFilter();
            renderInventoryList();
            renderSalesGrid(); 
            renderCart();
        }
        
        // --- UTIL ---
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]);
        }
        
        // --- MODAL FUNCTIONS ---
        function showConfirmModal(title, message, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.style.display = 'flex';
        }

        function hideConfirmModal() {
            confirmModal.style.display = 'none';
            confirmCallback = null; 
        }

        function handleConfirm() {
            if (typeof confirmCallback === 'function') {
                confirmCallback(); 
            }
            hideConfirmModal();
        }


        // --- EVENT HANDLERS ---
        
        function handleTabSwitch(e) {
            const selectedTab = e.target.id;
            
            contentRegister.classList.remove('active');
            contentInventory.classList.remove('active');
            contentSettings.classList.remove('active');
            tabRegister.classList.remove('active');
            tabInventory.classList.remove('active');
            tabSettings.classList.remove('active');

            if (selectedTab === 'tab-register') {
                tabRegister.classList.add('active');
                contentRegister.classList.add('active');
            } else if (selectedTab === 'tab-inventory') {
                tabInventory.classList.add('active');
                contentInventory.classList.add('active');
            } else if (selectedTab === 'tab-settings') {
                tabSettings.classList.add('active');
                contentSettings.classList.add('active');
            }
        }
        
        function handleSaveProduct(e) {
            e.preventDefault();
            const name = productNameInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            let sku = productSkuInput.value.trim();
            const category = productCategoryInput.value.trim();
            
            if (!name || isNaN(price) || price < 0) {
                alert("Product Name and a valid Price are required.");
                return;
            }

            if (!sku) {
                sku = 'item-' + Date.now();
            }
            
            const newProduct = { name, price, sku, category };
            const existingIndex = products.findIndex(p => p.sku === sku);
            
            if (existingIndex > -1) {
                products[existingIndex] = newProduct; 
            } else {
                products.push(newProduct); 
            }
            
            saveProducts(products);
            refreshAllUI();
            productForm.reset();
            productNameInput.focus(); 
        }
        
        function handleDeleteProduct(e) {
            if (!e.target.classList.contains('delete-btn')) return;
            const sku = e.target.dataset.sku;
            
            showConfirmModal("Delete Product", `Are you sure you want to delete product SKU: ${sku}?`, () => {
                products = products.filter(p => p.sku !== sku);
                saveProducts(products);
                refreshAllUI();
            });
        }
        
        function handleAddToCart(e) {
            const card = e.target.closest('.product-card');
            if (!card) return;
            
            const sku = card.dataset.sku;
            const product = products.find(p => p.sku === sku);
            
            const cartItem = cart.find(item => item.sku === sku);
            if (cartItem) {
                cartItem.qty += 1;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            
            renderCart();
        }
        
        function handleCartQtyChange(e) {
            if (!e.target.classList.contains('qty-btn')) return;
            
            const sku = e.target.dataset.sku;
            const action = e.target.dataset.action;
            const cartItem = cart.find(item => item.sku === sku);
            
            if (!cartItem) return;
            
            if (action === 'increment') {
                cartItem.qty += 1;
            } else if (action === 'decrement') {
                if (cartItem.qty === 1) {
                    cart = cart.filter(item => item.sku !== sku);
                } else {
                    cartItem.qty -= 1;
                }
            }
            
            renderCart();
        }
        
        function handleClearCart() {
            if (cart.length === 0) {
                cart = [];
                renderCart();
                return;
            }
            
            showConfirmModal("Clear Cart", "Are you sure you want to clear the current cart?", () => {
                cart = [];
                renderCart();
            });
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            settings.shopName = settingShopName.value;
            settings.shopAddress = settingShopAddress.value;
            settings.shopPhone = settingShopPhone.value;
            settings.footerNote = settingFooterNote.value;
            settings.taxRate = parseFloat(settingTaxRate.value) || 0;
            settings.layout = settingLayout.value;
            
            saveSettings();
            alert("Settings saved!");

            renderSalesGrid();
            renderCart(); 
        }
        
        // --- NEW ROBUST PRINT LOGIC ---
        function handlePrintReceipt() {
            if (cart.length === 0) {
                alert('Cart is empty.');
                return;
            }

            // 1. Calculate totals
            let subtotal = 0;
            cart.forEach(i => subtotal += i.price * i.qty);
            const tax = subtotal * (settings.taxRate / 100);
            const total = subtotal + tax;

            // 2. Build receipt items HTML string
            const itemsHtml = cart.map(item => `
                <tr>
                    <td>${escapeHtml(item.name)}</td>
                    <td class"col-qty">${item.qty}</td>
                    <td class="col-total">PKR ${(item.price * item.qty).toFixed(2)}</td>
                </tr>
            `).join('');

            // 3. Build the full receipt HTML document (as a string)
            const receiptHtml = `
                <!doctype html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>Receipt</title>
                    <meta name="viewport" content="width=device-width,initial-scale=1">
                    <style>
                        body { 
                            font-family: "Courier New", Courier, monospace; 
                            color:#000; 
                            margin:0; 
                            padding:10px; 
                            width: 280px; /* 58mm paper */
                        }
                        .receipt-print { width:100%; }
                        h2 { text-align:center; margin:0 0 6px 0; font-size:16px; }
                        .header-info { text-align:center; font-size:12px; margin-bottom:6px; }
                        table { width:100%; font-size:12px; border-collapse:collapse; }
                        th { text-align: left; border-bottom: 1px solid #000; padding: 4px 0; }
                        td { padding:4px 0; }
                        .col-qty { text-align:center; width:40px; }
                        .col-total { text-align:right; }
                        .totals-print { margin-top:10px; border-top:1px dashed #000; padding-top:5px; }
                        .totals-print div { display:flex; justify-content:space-between; font-weight:700; font-size:13px; }
                        .totals-print .total-row { font-size: 14px; }
                        .footer-print { text-align:center; margin-top:10px; font-size:12px; }
                    </style>
                </head>
                <body>
                    <div class="receipt-print">
                        <h2>${escapeHtml(settings.shopName)}</h2>
                        <div class="header-info">
                            ${escapeHtml(settings.shopAddress)}<br>
                            ${escapeHtml(settings.shopPhone)}
                        </div>
                        <div class="header-info">Transaction #: ${Date.now()}</div>
                        
                        <table>
                            <thead>
                                <tr><th>Item</th><th class="col-qty">Qty</th><th class="col-total">Total</th></tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>

                        <div class="totals-print">
                            <div><span>Subtotal:</span><span>PKR ${subtotal.toFixed(2)}</span></div>
                            <div><span>Tax (${settings.taxRate}%):</span><span>PKR ${tax.toFixed(2)}</span></div>
                            <div class="total-row"><span>Total:</span><span>PKR ${total.toFixed(2)}</span></div>
                        </div>

                        <div class="footer-print">
                            ${escapeHtml(settings.footerNote)}
                        </div>
                    </div>
                    
                    <script>
                        // Auto-print and close
                        function initPrint() {
                            try {
                                window.print();
                            } catch (e) {
                                console.error("Print failed", e);
                            }
                            // Close window after print dialog is handled
                            // Use a short delay for browsers that close the dialog immediately
                            setTimeout(() => {
                                try { window.close(); } catch (e) {}
                            }, 500);
                        }
                        // Use setTimeout to ensure DOM is ready before printing
                        setTimeout(initPrint, 100);
                    <\/script>
                </body>
                </html>
            `;

            // 4. Open the new window and write the HTML
            const printWindow = window.open('', '_blank', 'width=300,height=500,menubar=no,toolbar=no,scrollbars=yes');
            if (!printWindow) {
                alert("Popup blocked! Please allow popups for this site to print receipts.");
                return;
            }
            
            printWindow.document.open();
            printWindow.document.write(receiptHtml);
            printWindow.document.close();
            
            // 5. Poll the window to clear cart *after* it's closed
            const poll = setInterval(() => {
                if (!printWindow || printWindow.closed) {
                    clearInterval(poll);
                    cart = []; // Clear cart
                    renderCart(); // Update UI
                }
            }, 300); // Check every 300ms
        }
        
        // REMOVED: afterPrintActions and handleCloseMobileModal

        // --- DATA MANAGEMENT FUNCTIONS ---

        function downloadFile(content, fileName, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function exportDataJSON() {
            const dataToExport = {
                products: getProducts(),
                settings: settings
            };
            const dataString = JSON.stringify(dataToExport, null, 2); 
            downloadFile(dataString, 'pos_backup.json', 'application/json');
        }
        
        function exportDataCSV() {
            const products = getProducts();
            if (products.length === 0) {
                alert('No products to export.');
                return;
            }
            
            let csvContent = "sku,name,price,category\n"; 
            products.forEach(p => {
                csvContent += `${p.sku},"${p.name.replace(/"/g, '""')}",${p.price},"${(p.category || '').replace(/"/g, '""')}"\n`;
            });
            
            downloadFile(csvContent, 'pos_product_report.csv', 'text/csv');
        }

        function importDataJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    const importedData = JSON.parse(fileContent);
                    
                    if (!importedData.products || !importedData.settings) {
                        throw new Error("Invalid backup file format.");
                    }
                    
                    showConfirmModal("Import Data", "This will overwrite all current products AND settings. Continue?", () => {
                        saveProducts(importedData.products || []);
                        settings = { ...DEFAULT_SETTINGS, ...(importedData.settings || {}) };
                        saveSettings();
                        
                        alert('Backup restored successfully!');
                        updateSettingsUI();
                        refreshAllUI();
                    });

                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            };
            reader.readAsText(file);
            
            event.target.value = null; 
        }


        // --- ADD EVENT LISTENERS ---
        tabRegister?.addEventListener('click', handleTabSwitch);
        tabInventory?.addEventListener('click', handleTabSwitch);
        tabSettings?.addEventListener('click', handleTabSwitch);
        
        productForm?.addEventListener('submit', handleSaveProduct);
        inventoryTbody?.addEventListener('click', handleDeleteProduct);
        
        salesGrid?.addEventListener('click', handleAddToCart);
        
        productSearch?.addEventListener('input', () => renderSalesGrid());
        filterCategory?.addEventListener('change', () => renderSalesGrid());
        sortBy?.addEventListener('change', () => renderSalesGrid());

        
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                productSearch.focus();
            }
        });
        
        cartItemsContainer?.addEventListener('click', handleCartQtyChange);
        clearCartButton?.addEventListener('click', handleClearCart);
        payButton?.addEventListener('click', handlePrintReceipt);
        // REMOVED: closePrintModalBtn listener
        
        confirmModalCancelBtn?.addEventListener('click', hideConfirmModal);
        confirmModalConfirmBtn?.addEventListener('click', handleConfirm);
        
        settingsForm?.addEventListener('submit', handleSaveSettings);
        exportJsonBtn?.addEventListener('click', exportDataJSON);
        exportCsvBtn?.addEventListener('click', exportDataCSV);
        importFileEl?.addEventListener('change', importDataJSON);

        // REMOVED: window.onafterprint listener

        // --- INITIAL LOAD ---
        loadSettings();
        updateSettingsUI();
        refreshAllUI();
    });
    </script>
</body>
</html>


